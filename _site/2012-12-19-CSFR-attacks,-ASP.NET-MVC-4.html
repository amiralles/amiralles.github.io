---           
layout: post
title: CSFR attacks, ASP.NET MVC 4
date: 2012-12-19 15:25:30 UTC
updated: 2012-12-19 15:25:30 UTC
comments: false
categories: ASP.NET MVC 4 CSRF Hacking
---
<br /><div class="MsoNormal"><span lang="EN-US">CSRF stands for Cross Site Request Forgery and is a technique employed to fooling a website by executing commands on behalf of a trusted (authenticated) user.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"><b>How it works</b><o:p></o:p></span></div><div class="MsoNormal">Commonly a malicious user sends a link to another user that maybe is authenticated on the target site and uses their session to execute commands like transfer money, change the email address and stuff like that.</div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"><b>CSRF in action</b><o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><span lang="EN-US">This time I’ll be working on a web site that allows authenticated users buy pastries at the online store. In this case, the goal of the attacker is to get a bunch of muffins on somebody else’s Mastercard.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">The target site has a couple of web pages that allow users to logon, buy products and see their orders history:<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Rym0UNJBnxw/UNHPqOxHgcI/AAAAAAAAAaA/TD7Ut3wr88E/s1600/landing-page.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-Rym0UNJBnxw/UNHPqOxHgcI/AAAAAAAAAaA/TD7Ut3wr88E/s1600/landing-page.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"></div><div class="MsoNormal">Before going on, something to worth to mention is that <span style="background-color: yellow;">after a user is successfully authenticated to a &nbsp;website, the web browser will be sending the authentication cookie on every subsequent request to the server until the session expire (usually after 20 minutes of inactivity). This means that any incoming request from that session won’t be challenged for authentication</span> (The user will not be redirected to the login page) even if they were accessing to secure resources.</div><div class="MsoNormal"><br /></div><div class="MsoNormal">By using a web debugging tool like Fiddler we can inspect the HTTP traffic, view the HTTP headers and understand how it works.</div><div class="MsoNormal"><br /></div><br /><div class="MsoNormal"></div><div class="MsoNormal"><span lang="EN-US">On login:<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-TffWHCA4V48/UNHP__K0c4I/AAAAAAAAAaI/atsn93kKWkg/s1600/login-request.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-TffWHCA4V48/UNHP__K0c4I/AAAAAAAAAaI/atsn93kKWkg/s1600/login-request.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">On every subsequent request after a successful login:<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-VHWcoEETESA/UNHQPT57oxI/AAAAAAAAAaQ/M3a3XCD5VjM/s1600/view-orders.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="214" src="http://1.bp.blogspot.com/-VHWcoEETESA/UNHQPT57oxI/AAAAAAAAAaQ/M3a3XCD5VjM/s640/view-orders.png" width="640" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"><b>* ASPXAUTH is the ASP.NET authentication cookie.</b></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">If an attacker can see the source code of the target page, he can easily compose and submit a form to perform a CSRF attack. <o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><span lang="EN-US"><b>The bad guy at work</b><o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US">Doing a little of social engineering, the bad guy figures it out that the target site is very busy on Friday morning where everybody is buying pastries for the office (which is a common thing to do in my country), so he assumes that by sending emails with links to the website’s hottest offers to a bunch of people, eventually a couple of them will be customers and maybe be interested on those offers, so they will be clicking on those links and if one of them still have the session's cookie alive, he will become a victim of the attack.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><span lang="EN-US"><b>How to compose and submit the form</b><o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US">The first step is take a look at the target page source code<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-ySpSua5lDyA/UNHQpjngH1I/AAAAAAAAAaY/HN9NQpzjuMw/s1600/place-your-order.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="300" src="http://1.bp.blogspot.com/-ySpSua5lDyA/UNHQpjngH1I/AAAAAAAAAaY/HN9NQpzjuMw/s320/place-your-order.png" width="320" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-UN3AZxmQZ2Y/UNHQvlrUKmI/AAAAAAAAAag/sp9bMEwHMfc/s1600/place-your-order-source.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-UN3AZxmQZ2Y/UNHQvlrUKmI/AAAAAAAAAag/sp9bMEwHMfc/s1600/place-your-order-source.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">Now that we know the form structure, we can build a script like this:<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-fDBevy2vgTc/UNHQ5c82y1I/AAAAAAAAAao/-yfMR0A3Wfw/s1600/attack-script.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-fDBevy2vgTc/UNHQ5c82y1I/AAAAAAAAAao/-yfMR0A3Wfw/s1600/attack-script.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal">By using this script we are posting an order at the online store using the good guy's session that will be delivered to the bad guy's address (Also note that the form won't be displayed at all).</div><div class="MsoNormal"><span lang="EN-US"><b><br /></b></span></div><div class="MsoNormal"><span lang="EN-US"><b>Wanna try it yourself?</b><o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US">Follow these steps:<o:p></o:p></span></div><div class="MsoNormal"></div><ol><li>Download the sample app from&nbsp;<a href="https://github.com/amiralles/csrf" target="_blank">here</a></li><li>Build and run the website</li><li>Register/Login</li><li>Place an order</li><li>View your orders history</li></ol><div><div class="MsoNormal"><span lang="EN-US">So far, you just have used the site. Now click on <a href="http://amiralles.com.ar/foo.html" target="_blank">this link</a>&nbsp;(this is the link that the bad guy will be sending by email)&nbsp;<o:p></o:p></span>&nbsp;and you will see what happen. You should see a page with the message "The offer has expired, blah, blah, blah..." and then will be redirected to our website’s main page).</div><div class="MsoNormal"><br /></div><div class="MsoNormal"><span lang="EN-US">Now go to see your orders history and you will see what really happened ;)<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">If all went as planned, you should be seeing an order that you haven't posted, where the delivery address point to the bad guy's address, if this were a real site, this would have been aCSRF attack; you will be paying the bills and the bad guy will be getting stuff.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">In future posts I’ll be covering some alternatives that ASP.NET provides to prevent this kind of attacks.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">Note: this technique does not apply only to ASP.NET, CSRF attacks can be performed against other web technology such as Ruby on Rails or PHP.<o:p></o:p></span></div></div><br />        <br /><br /><br /><br /><br />