---           
layout: post
title: Deferred execution in C#
date: 2012-03-27 13:22:33 UTC
updated: 2012-03-27 13:22:33 UTC
comments: false
categories: C#
---
<div class="MsoNormal" style="text-align: left;"><span style="font-family: Georgia, 'Times New Roman', serif;">A lot of times, fellow developers ask me about yield return keyword and what this keyword is for.</span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">This keyword allows us to iterate over enumerable collections in a more efficient way. Basically what does is tells the compiler do not execute this code unless is strictly necessary (for this reason it’s also called lazy evaluation).<o:p></o:p></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">I wrote a little sample that shows the keyword in action. The purpose of this code is to convert a DataTable into a Collection of objects. Maybe the algorithm is not the best way to accomplish the job but clearly shows how yield return works.<o:p></o:p></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">To see the advantages of lazy evaluation we first should take look at how the code will work if we don’t use it.<o:p></o:p></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">Here I convert a DataTable that contains four rows into a collection of objects and take the first element from the result. This version of convert works eagerly.<o:p></o:p></span></div><div class="separator" style="clear: both; text-align: left;"><a href="http://2.bp.blogspot.com/-sPan3Fb22WQ/T3G5XhP-HEI/AAAAAAAAAC0/V_f9z8IYuKk/s1600/eager-convert.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><span style="font-family: Georgia, 'Times New Roman', serif;"><img border="0" height="240" src="http://2.bp.blogspot.com/-sPan3Fb22WQ/T3G5XhP-HEI/AAAAAAAAAC0/V_f9z8IYuKk/s640/eager-convert.png" width="640" /></span></a></div><div class="MsoNormal" style="text-align: left;"><span style="font-family: Georgia, 'Times New Roman', serif;"><br /></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">And the result is:<o:p></o:p></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;"><br /></span></div><div class="separator" style="clear: both; text-align: left;"><a href="http://3.bp.blogspot.com/-ShrshmJxoWE/T3G5dSMv62I/AAAAAAAAAC8/WHCa0JwTA3U/s1600/eager-convert-execute.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><span style="font-family: Georgia, 'Times New Roman', serif;"><img border="0" height="344" src="http://3.bp.blogspot.com/-ShrshmJxoWE/T3G5dSMv62I/AAAAAAAAAC8/WHCa0JwTA3U/s640/eager-convert-execute.png" width="640" /></span></a></div><div class="MsoNormal" style="text-align: left;"><span style="font-family: Georgia, 'Times New Roman', serif;"><br /></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">As we can see this in the output window, this version of the convert method walks thru the whole rows collection converting each row into an object even when we only need the first one. With a large set of data or expensive convert operation this method will perform poorly.<o:p></o:p></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">A better approach will be creating a method that is smart enough to not convert the whole data set when we only need the first element. This version could look something like this:<o:p></o:p></span></div><div class="separator" style="clear: both; text-align: left;"><a href="http://3.bp.blogspot.com/-e8soE0ERag0/T3G5fKygW6I/AAAAAAAAADM/hMAnxmMnz5Q/s1600/lazy-convert.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><span style="font-family: Georgia, 'Times New Roman', serif;"><img border="0" height="188" src="http://3.bp.blogspot.com/-e8soE0ERag0/T3G5fKygW6I/AAAAAAAAADM/hMAnxmMnz5Q/s640/lazy-convert.png" width="640" /></span></a></div><div class="MsoNormal" style="text-align: left;"><span style="font-family: Georgia, 'Times New Roman', serif;"><br /></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;">When we execute this method, &nbsp;we get the same result that we got before but this time we don’t walked over the whole collection of rows, when we find the first element we just stop enumerating and return the result. In this case, the second implementation performs better than the first one, saving a couple of CPU cycles and memory consumption.<o:p></o:p></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US" style="font-family: Georgia, 'Times New Roman', serif;"><br /></span></div><div class="separator" style="clear: both; text-align: left;"><a href="http://1.bp.blogspot.com/-5jDE1_okza4/T3G5eKZk-UI/AAAAAAAAADE/48p91Dymr38/s1600/lazy-convert-execute.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><span style="font-family: Georgia, 'Times New Roman', serif;"><img border="0" height="354" src="http://1.bp.blogspot.com/-5jDE1_okza4/T3G5eKZk-UI/AAAAAAAAADE/48p91Dymr38/s640/lazy-convert-execute.png" width="640" /></span></a></div><div class="MsoNormal" style="text-align: left;"><span style="font-family: Georgia, 'Times New Roman', serif;"><br /></span></div><div class="MsoNormal" style="text-align: left;"><span lang="EN-US"><span style="font-family: Georgia, 'Times New Roman', serif;">This is just a sneak pick of how deferred execution works in C# and the power that LINQ brought to the .NET Framework.&nbsp;</span><o:p></o:p></span></div>