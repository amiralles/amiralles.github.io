---           
layout: post
title: Hidden memory leaks in WinForm Apps
date: 2013-02-18 14:04:32 UTC
updated: 2013-02-18 14:04:32 UTC
comments: false
categories: Memory Leaks WinForms
---
<br /><div class="MsoNormal"><span lang="EN-US">Dealing with memory leaks in .NET apps it is always a hard thing to do. While the GC does a great job (most of the time) freeing us to worry about memory management, there are some edge cases where we have to be very careful to not screw things up.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><span lang="EN-US">In this post I am going to show a common issue I see when doing code reviews on WinForm apps. <o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US">First, let’s take a look at this code and see what it is wrong with it.</span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-B3Auy_Qn76A/USIwQ3tsbTI/AAAAAAAAAfw/xol9J4J1rSw/s1600/frm-mem-leak.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-B3Auy_Qn76A/USIwQ3tsbTI/AAAAAAAAAfw/xol9J4J1rSw/s1600/frm-mem-leak.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><span lang="EN-US">As you can guess, the problem with the code above is that creates a memory leak ;). But why? We are (correctly?) disposing FrmFoo...<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">This line of code creates two issues,<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-9g3-jPuiSok/USIwjn8q2lI/AAAAAAAAAf4/oGNYIMJXfLY/s1600/frm-line-issue.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-9g3-jPuiSok/USIwjn8q2lI/AAAAAAAAAf4/oGNYIMJXfLY/s1600/frm-line-issue.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal">The first one, the GC will never be able to collect the garbage created inside the closure generated by the lambda expression attached to the control’s click event. Even when we are disposing the form, the object created by the C# compiler is rooted inside the scope of the closure and cannot be destroyed, hence the memory leak.</div><div class="MsoNormal"><br /></div><div class="MsoNormal"></div><div class="MsoNormal"><span lang="EN-US">The second one, we don’t have access from an outer scope to the delegate attached to the click event, so we cannot effectively remove it while disposing the form. Which is a good practice and almost no one does it (including myself).<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><span lang="EN-US">For the last issue, I made an extension method that solves the problem, but the first one still remains....<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">This is a nice way to implement the same use case without introducing memory leaks.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-_a2wp0wKv4A/USIw7uss-2I/AAAAAAAAAgA/U_OPeqf4dZw/s1600/frm-the-right-way.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-_a2wp0wKv4A/USIw7uss-2I/AAAAAAAAAgA/U_OPeqf4dZw/s1600/frm-the-right-way.png" /></a></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"></span></div><div class="MsoNormal"><span lang="EN-US">I know this is a trivial example and the impact of memory issues is almost none, but be careful with these kind of stuff, usually, issues like these are really tough and takes a lot of time to deal with them.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US">Here, the list of tools I frequently use to work on performance/memory related issues.<o:p></o:p></span></div><div class="MsoNormal"><span lang="EN-US"><br /></span></div><div class="MsoNormal"><span lang="EN-US"><a href="http://memprofiler.com/" target="_blank">.NET Memory Profiler</a></span></div><div class="MsoNormal"><a href="http://www.jetbrains.com/profiler/features/index.html#Memory_profiling" target="_blank">dotTrace Memory</a></div><div class="MsoNormal"><a href="http://www.jetbrains.com/profiler/features/index.html#Performance_profiling" target="_blank">dotTrace Performance</a></div><div class="MsoNormal"><br /></div><br /><br /><br /><br /><br /><br />